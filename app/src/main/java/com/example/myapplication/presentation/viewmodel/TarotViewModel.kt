package com.example.myapplication.presentation.viewmodel

import android.app.Application
import android.content.Context
import android.content.SharedPreferences
import androidx.lifecycle.AndroidViewModel
import androidx.lifecycle.viewModelScope
import com.example.myapplication.data.local.TarotDatabase
import com.example.myapplication.data.repository.TarotRepositoryImpl
import com.example.myapplication.domain.model.TarotCard
import kotlinx.coroutines.flow.MutableStateFlow
import kotlinx.coroutines.flow.StateFlow
import kotlinx.coroutines.flow.asStateFlow
import kotlinx.coroutines.launch
import android.util.Log

class TarotViewModel(
    application: Application,
    private val repository: TarotRepositoryImpl
) : AndroidViewModel(application) {
    private val _selectedCards = MutableStateFlow<List<TarotCard>>(emptyList())
    val selectedCards: StateFlow<List<TarotCard>> = _selectedCards.asStateFlow()

    private val _canGetPrediction = MutableStateFlow(true)
    val canGetPrediction: StateFlow<Boolean> = _canGetPrediction.asStateFlow()
    private val prefs: SharedPreferences = application.getSharedPreferences("tarot_prefs", Context.MODE_PRIVATE)
    private val PREDICTION_TIME_KEY = "last_prediction_time"
    private val CARD_KEY = "last_prediction_card"

    init {
        viewModelScope.launch {
            val initialCards = listOf(
                TarotCard("fool", "Шут: хорошее настроение, приятные сюрпризы и поездки. Однако некоторые иллюзии могут оказаться обманчивыми, поэтому не стоит назначать романтических свиданий или серьёзных переговоров. Посвятите свой день отдыху или здоровью, ну или просто радуйтесь жизни."),
                TarotCard("magician", "Маг: обещает успех во всех начинаниях, особенно для людей творческих и инициативных, имеющих лидерские способности и готовых познавать свои возможности. Не исключена так же помощь со стороны влиятельного человека, прислушивайтесь к его мудрым советам и тогда недоброжелатели и завистники уйдут посрамлёнными."),
                TarotCard("highpriestess", "Верховная Жрица: символизирует бессознательное, намекая, что предстоящие события зависят от того, что вы делаете сегодня. Учитесь и познавайте, так вы наработаете потенциал для достижения целей. Сегодня не хватает какой-то информации, что осложняет работу, однако возможные проблемы никак не повлияют на дальнейшие перспективы. Лучше всего будет удаваться умственная работа"),
                TarotCard("empress", "Императрица: напомнит вам о себе, принеся новость, введя в сомнение или даже разочарование своими рассказами, однако в остальном эта карта положительна и обозначает добрую силу и спокойствие, а так же творческий потенциал, указывая, что день будет хорошим. Иногда это встреча с хорошей подругой, а для мужчин с любовницей или вообще новое знакомство"),
                TarotCard("emperor", "Император: вы можете почувствовать прилив сил и необходимость их реализовать с помощью имеющихся талантов. При гадании на день может проявиться тайное стремление к власти или контролю над тем, что происходит вокруг вас. Возможно появление властного мужчины, который обладает опытом, силой и готов оказать помощь, когда это потребуется."),
                TarotCard("hierophant", "Иерофант: надо прислушаться к своей интуиции для верной интерпретации поступающих новостей. Возможна встреча с пожилыми родственниками, а так же указание, что для получения желаемого результата надо воспользоваться мудрым советом авторитетного и знающего человека."),
                TarotCard("lovers", "Влюблённые: будет всё — соблазны и переживания, чувства и попытка сделать правильный выбор. Опасайтесь путаницы в голове, эмоции могут её закружить и не спешите с окончательным решением. Возможно предстоит спор со своим внутренним «Я», однако он разрешится благополучно. Иногда аркан предвещает поездки или предстоящие путешествия."),
                TarotCard("chariot", "Колесница: просматривается возможность браться за дела, которые были остановлены. Сейчас не надо опасаться преград, смело преодолевайте все трудности, это вам теперь по плечу. Аркан так же указывает на вероятность поездок или командировок, связанных с завершением начатых дел. Колесница так же обещает интересные события, эмоции и впечатления."),
                TarotCard("strength", "Сила:  усмирите в себе излишнюю эмоциональность, прогоните сомнения и прислушайтесь к внутреннему голосу, он подскажет правильное решение. Возможно вам не хватает мотивации, попробуйте сосредоточиться и следуйте своей линии во всём."),
                TarotCard("hermit", "Отшельник: посвятите себя учёбе, прислушайтесь к мнению окружающих, однако не раскрывайте своих взглядов на дело. Сегодня может понадобиться тщательный анализ неопределённой ситуации, который потребует времени, поэтому не торопитесь с решениями, постарайтесь не назначать никаких мероприятий, способных отвлечь вас."),
                TarotCard("wheeloffortune", "Колесо Фортуны: фортуна к вам повернулось лицом, но для полного раскрытия необходимо приложить собственные усилия и «раскрутить» его, в противном случае результат совершенно неочевиден. Аркан так же советует заняться анализом ситуации для выбора правильного пути её развития."),
                TarotCard("justice", "Справедливость: неожиданные решения для застаревшей ситуации, которая приносила потери и переживания, после чего всё нормализуется и равновесие будет восстановлено. При гадании на день так же есть указания на вероятность обращения за помощью в органы власти для восстановления справедливости или решения бумажных вопросов."),
                TarotCard("hangedman", "Повешенный: попытка переосмыслить свои взгляды на жизнь и отказаться от существующих стереотипов. При гадании на день может получиться, что всё встанет с ног на голову, хотя и обратный вариант тоже возможен. Посыл аркана в том, чтобы проявлять осторожность из-за неопределённости ситуации и в поиске нестандартного решения вопросов."),
                TarotCard("death", "Смерть: предвещает перемены, которые нельзя откатить назад и они должны случиться сегодня. Перемены скорее всего будут положительными, но весьма радикальными, после которых жизнь потечёт в ином русле. Одновременно аркан предостерегает от резких движений, а тем более непродуманных действий."),
                TarotCard("temperance", "Умеренность: можно ожидать спокойного и гладкого течения событий, однако при условии, что сам кверент на это настроен и расположен к терпению и умеренности во всём. Если же настрой у человека будет агрессивным, то результат может оказаться противоположным и очень далёким от желаемого. Умеренность советует посвятить этот день общению с близкими, приятным занятиям или просто отдыху."),
                TarotCard("devil", "Дьявол: предвещает обилие соблазнов, вероятны проблемы из-за того, что человек подпортил себе карму. Возможны беспричинные страхи и ощущение скрытой опасности. На всякий случай будьте осторожны, лучше перенесите важные дела на другой день. Иногда карта указывает, что вам необходимо внести перемены в своё отношение к деньгам, ибо это к хорошему не приведёт."),
                TarotCard("tower", "Башня: надо избегать рискованных мероприятий, поездок, не стоит брать взаймы, т.к. всё это может иметь неожиданные последствия. Погоня за сиюминутной выгодой может обернуться неприятными событиями, которых лучше избежать. Желание получить всё и сразу чревато крушением планов и поэтому надо проявлять благоразумие, осторожность и рассудительность."),
                TarotCard("star", "Звезда: олицетворяет позитив и указывает дорогу к достижению поставленных целей, символизируя творческий расцвет и покровительство сил Вселенной. Сегодня все начинания будут успешными, особенно для людей творческих, способных реализовывать скрытый потенциал и готовых браться за сложные начинания."),
                TarotCard("moon", "Луна: доверьтесь своей интуиции. В значении карты дня здесь можно увидеть воздушные замки и иллюзии, в которых прибывает кверент, что говорит о необходимости использования разума, чтобы избежать самообмана и наплыва негативных эмоций."),
                TarotCard("sun", "Солнце: символизирует уверенность в себе и в значении карты дня говорит о необходимости продолжать начатое дело, которое приведёт к успеху. Сегодня могут разрешиться застарелые ситуации, что вызовет много положительных эмоций и даже ощущение счастья, прилив жизненной энергии. Любые дела, начатые в этот день обязательно будут успешными."),
                TarotCard("judgment", "Суд: тайное становится явным и тёмные стороны личности, равно как и добрые дела, будут доступны окружающим. Наберитесь смелости встретится с этим фактом лицом к лицу и ничему не удивляйтесь, примите к сведению и постарайтесь избавиться от всего, что отягощает. Но чаще всего аркан символизирует награду высших сил за «хорошее поведение».\n" +
                        "\n"),
                TarotCard("world", "Мир: можно увидеть тенденции к примирению и завершению конфликтов. Всё пройдёт спокойно и гладко, впереди только самое лучшее, вы близки к гармонии с миром и собственным «Я», однако вам надо при этом проявить добрую волю и избегать споров, ссор и проявления нетерпимости по отношению к окружающим людям и событиям.")
            )
            repository.insertCards(initialCards)
            checkPredictionAvailable()
        }
    }

    fun getRandomPrediction() {
        viewModelScope.launch {
            val now = System.currentTimeMillis()
            val lastTime = prefs.getLong(PREDICTION_TIME_KEY, 0L)
            Log.d("TarotViewModel", "getRandomPrediction: now=$now, lastTime=$lastTime, diff=${now - lastTime}")
            if (now - lastTime < 24 * 60 * 60 * 1000) {
                Log.d("TarotViewModel", "Prediction already received today, skipping")
                return@launch
            }
            val cards = repository.getRandomCards()
            Log.d("TarotViewModel", "Random card: ${cards.firstOrNull()?.imageName}")
            _selectedCards.value = cards
            prefs.edit().putLong(PREDICTION_TIME_KEY, now)
                .putString(CARD_KEY, cards.firstOrNull()?.imageName ?: "")
                .apply()
            _canGetPrediction.value = false
            Log.d("TarotViewModel", "Prediction set, canGetPrediction=false")
        }
    }

    fun checkPredictionAvailable() {
        viewModelScope.launch {
            val allCards = repository.getAllCardsOnce()
            if (allCards.isEmpty()) {
                _canGetPrediction.value = true
                _selectedCards.value = emptyList()
                return@launch
            }
            val now = System.currentTimeMillis()
            val lastTime = prefs.getLong(PREDICTION_TIME_KEY, 0L)
            val canGet = (now - lastTime >= 24 * 60 * 60 * 1000)
            _canGetPrediction.value = canGet
            if (!canGet) {
                val imageName = prefs.getString(CARD_KEY, null)
                if (imageName != null && imageName.isNotEmpty()) {
                    val card = allCards.find { it.imageName == imageName }
                    if (card != null) {
                        _selectedCards.value = listOf(card)
                    }
                }
            } else {
                _selectedCards.value = emptyList()
            }
        }
    }
} 